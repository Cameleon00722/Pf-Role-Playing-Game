(* fonction import *)

Random.self_init();;


(* création personnage *)

type genre = Male | Female
type classe = Guerrier | Archer | Magicien
type item = | Eponge | Piece | Cuisse_poulet ;;
type quantite = int ;;
type items = { item: item; quantite: quantite} ;;


type personnage = {nom : string ; classe : classe ;  genre : genre ; pv: int; exp : int; niveau : int; sac : items list; speed : int} ;;

type personnage = {nom : string ; classe : classe ;  genre : genre ; pv: int; exp : int; niveau : int; sac : items list; speed : int}

let speed_perso  = fun perso -> match perso.classe with
  | Guerrier -> 5
  | Archer -> 7
  | Magicien -> 3

(* partie monstre *)

type type_de_monstre = | Golem | Nuee_de_moustiques | Sanglier | Slime


type monstre = {nom : type_de_monstre ; pv : int ; attaque : int ; loot : item; nombre : int; speed :int };;

let pv_monstre  = fun mstr -> match mstr.nom with
  | Golem -> mstr.pv + Random.int 6
  | Nuee_de_moustiques -> mstr.pv + Random.int 10
  | Sanglier -> mstr.pv + Random.int 4
  | Slime -> mstr.pv + Random.int 4;;


(* Gameplay personnage *)

(*type item = | Eponge | Piece | Cuisse_poulet ;;
 type quantite = int ;;
 type items = { item: item; quantite: quantite} ;;*)

let item_to_string : item -> string = fun it->
  match it with
  | Eponge -> "éponges"
  | Piece -> "pièces"
  | Cuisse_poulet -> "poulets" ;;

let rec afficher_contenu_sac = fun sac ->
  match sac with
  |[]-> print_string "\n"
  |{item=i; quantite= q}::tl when q>0->
      print_int q;
      print_string (" "^(item_to_string i));
      print_string "\n";
      afficher_contenu_sac tl
  |{item=i; quantite= q}::tl-> afficher_contenu_sac tl;;
exception No_food
    (*affichage du sac *)
      (*ligne de séparation*)
let rec iterate : (int * ('a->'a) * 'a) -> 'a =
  fun (count, f, initial_value) ->
    if count <= 0
    then initial_value
    else iterate (count-1, f, f initial_value)
let repeat_string= fun (s,n) -> iterate (n, (fun s1->s^s1),"")
let enclosing=  fun s -> iterate (1, (fun s1->"+"^s^"+ \n"),s)
let end_line = fun s-> iterate (1, (fun s1->s^"\n"),s)
let separation= fun s->
  end_line(enclosing (repeat_string (s, 29)))
  (*ligne 1*)
let classe_genree = fun perso ->
  if perso.genre= Male
  then match perso.classe with
    | Guerrier -> "Guerrier"
    | Archer -> "Archer"
    | Magicien -> "Magicien"
  else match perso.classe with
    | Guerrier -> "Guerrière"
    | Archer -> "Archère"
    | Magicien -> "Magicienne" ;;

let ligne_1 : personnage -> string = fun perso ->
  "| "^perso.nom^" | "^(classe_genree perso)^"  niveau  "^(string_of_int perso.niveau)^"  |"
      (*ligne 2*)
let ligne_2 : personnage -> string= fun perso ->
  "| Points de vie       |    "^(string_of_int perso.pv)^" |";;
    (* ligne 3*)
let ligne_3= fun perso ->
  "| Expérience          |     "^(string_of_int perso.exp)^" |";;
  (*ligne 4*)
  (*les geetteurs*)
let rec get_nb_poulet = fun sac ->
  match sac with
  |[]-> 0
  |{item=Cuisse_poulet; quantite=q}::_->q
  |{item=_; quantite=_}::tl-> get_nb_poulet tl ;;
let rec get_nb_piece = fun sac ->
  match sac with
  |[]-> 0
  |{item=Piece; quantite=q}::_->q
  |{item=_; quantite=_}::tl-> get_nb_piece tl ;;
let rec get_nb_eponge = fun sac ->
  match sac with
  |[]-> 0
  |{item=Eponge; quantite=q}::_->q
  |{item=_; quantite=_}::tl-> get_nb_eponge tl ;;

let ligne_4 : personnage -> string = fun perso ->
  "| Sac                         |\n"
  ^"| "^string_of_int (get_nb_eponge perso.sac)^" éponges                   |\n"
  ^"| "^string_of_int (get_nb_poulet perso.sac)^" poulets                   |\n"
  ^"| "^string_of_int (get_nb_piece perso.sac)^" pièces                    |\n" ;;
  (*affichage total*)
let affichage_etat_perso = fun perso ->
  print_string (separation "-");
  print_string (end_line(ligne_1 perso));
  print_string (separation "-");
  print_string (end_line(ligne_2 perso));
  print_string (separation "-");
  print_string (end_line(ligne_3 perso));
  print_string (separation "-");
  print_string (end_line(ligne_4 perso));
  print_string (separation "-");;

let frapper  = fun perso -> match perso.classe with
  | Guerrier -> if(Random.int 100 <30+perso.niveau*5) then 10 else 0
  | Archer -> if(Random.int 100 <70+perso.niveau*5) then 4 else 0
  | Magicien -> if(Random.int 100 <50+perso.niveau*5) then 5 else 0;;

let frapper_monstre = fun monstre -> match monstre.nom with
  | Golem -> 4
  | Nuee_de_moustiques -> 1/2*monstre.nombre
  | Sanglier -> 2
  | Slime -> 8;;

(*manger*)
(*pour voir si le perso a du poulet*)
let rec manger_aux =fun sac->
  match sac with
  |[]->false
  |{item=i; quantite=q}::tl when i=Cuisse_poulet-> if q>0
      then true
      else false
  |{item=i; quantite=q}::tl-> manger_aux tl ;;
(*pour décrémenter le nb de poulet*)
let rec manger_poulet = fun sac ->
  match sac with
  |[]->[]
  |{item=i; quantite=q}::tl when i=Cuisse_poulet->{item=i; quantite=q-1}:: manger_poulet tl
  |{item=i; quantite=q}::tl-> {item=i; quantite=q}::manger_poulet tl ;;

 (*pour voir si le perso a du poulet*)
let rec manger_aux =fun sac->
  match sac with
  |[]->false
  |{item=i; quantite=q}::tl when i=Cuisse_poulet-> if q>0
      then true
      else false
  |{item=i; quantite=q}::tl-> manger_aux tl ;;

let manger= fun perso ->
  if (manger_aux perso.sac)
  then if perso.pv<20
    then (true,{nom=perso.nom; classe= perso.classe; genre=perso.genre; pv=perso.pv+2; exp=perso.exp; niveau=perso.niveau; sac=(manger_poulet perso.sac); speed = perso.speed})
    else (true,{nom=perso.nom; classe= perso.classe; genre=perso.genre; pv=perso.pv; exp=perso.exp; niveau=perso.niveau; sac=(manger_poulet perso.sac); speed = perso.speed})
  else (false,perso);;


(* combat *)

let passer_niveau_sup : int -> int -> bool= fun pv niv ->
  if ((float_of_int pv)>=2.**(((float_of_int niv)+.1.))*.10.) then true else false;;



let rec combien_coup_achever_perso : monstre -> int -> int = fun m pv -> 
  if(pv<=0) then 0 else (combien_coup_achever_perso m (pv-frapper_monstre m ))+1;;

let rec combien_coup_achever_monstre : personnage -> int -> int = fun p pv ->
  if(pv<=0) then 0 else (combien_coup_achever_monstre p (pv-frapper p))+1;;
  
let min = fun a b ->
  if(a>=b) then b else a ;;


let combattre : personnage -> monstre -> personnage = fun p m -> match m.nom with
  | Golem -> let a=(combien_coup_achever_monstre p m.pv) and b=(combien_coup_achever_perso m p.pv) in  if(b<=a) then failwith "perso_mort" else 
       
        {nom=p.nom ; classe=p.classe;  genre=p.genre ; pv=p.pv - frapper_monstre m * (min a b); exp=8; 
         niveau=b ; sac=p.sac@[{ item=m.loot; quantite=1}]; speed = p.speed}
        
        
  | Nuee_de_moustiques ->let a=(combien_coup_achever_monstre p m.pv) and b=(combien_coup_achever_perso m p.pv) in  if(b<=a) then failwith "perso_mort" else 
       
        {nom=p.nom ; classe=p.classe;  genre=p.genre ; pv=p.pv - frapper_monstre m * (min a b); exp=p.exp + 2; 
         niveau=if((passer_niveau_sup p.pv p.niveau)==true) then p.niveau+1 else p.niveau ; sac=p.sac@[{ item=m.loot; quantite=1}]; speed = p.speed}
        
        
  | Sanglier -> let a=(combien_coup_achever_monstre p m.pv) and b=(combien_coup_achever_perso m p.pv) in  if(b<=a) then failwith "perso_mort" else 
       
        {nom=p.nom ; classe=p.classe;  genre=p.genre ; pv=p.pv - frapper_monstre m * (min a b); exp=p.exp + 4; 
         niveau=if((passer_niveau_sup p.pv p.niveau)==true) then p.niveau+1 else p.niveau ; sac=p.sac@[{ item=m.loot; quantite=1}]; speed = p.speed}

  | Slime -> let a=(combien_coup_achever_monstre p m.pv) and b=(combien_coup_achever_perso m p.pv) in  if(b<=a) then failwith "perso_mort" else 
       
        {nom=p.nom ; classe=p.classe;  genre=p.genre ; pv=p.pv - frapper_monstre m * (min a b); exp=p.exp + 4; 
         niveau=if((passer_niveau_sup p.pv p.niveau)==true) then p.niveau+1 else p.niveau ; sac=p.sac@[{ item=m.loot; quantite=1}]; speed = p.speed};;


let rec fuir = fun sac ->
  match sac with
  |[]->[]
  |{item=i; quantite=q}::tl when i=Piece->{item=i; quantite=q - Random.int q}:: fuir tl
  |{item=i; quantite=q}::tl-> {item=i; quantite=q}::fuir tl ;;


let generer_type_monstre = fun a -> match a with
  | 0 -> Golem
  | 1 -> Nuee_de_moustiques
  | 2 -> Sanglier
  | 3 -> Slime;;


let generer_butin = fun a -> match a with
  | 0 -> Eponge
  | 1 -> Piece
  | 2 -> Cuisse_poulet;;

let generer_monstre_0 = 
  {nom=(generer_type_monstre (Random.int 4)); pv = 0 ; attaque = 0 ; loot= (generer_butin (Random.int 3)) ; nombre = 0 ; speed = 0};;

let generer_pv_loot_1 = fun mstr -> match mstr.nom with
  | Golem ->  {nom=mstr.nom; pv = mstr.pv + Random.int 6 ; attaque = 0 ; loot= mstr.loot ; nombre = 1; speed = 2}
  | Nuee_de_moustiques ->  {nom=mstr.nom; pv = mstr.pv +  1 * mstr.nombre ; attaque = 0 ; loot= mstr.loot ; nombre = Random.int 250; speed = 8}
  | Sanglier ->  {nom=mstr.nom; pv = mstr.pv + Random.int 4 ; attaque = 0 ; loot= mstr.loot ; nombre = 1; speed = 4}
  | Slime ->  {nom=mstr.nom; pv = mstr.pv + Random.int 4 ; attaque = 0 ; loot= mstr.loot ; nombre = 1; speed = 1};;

let generer_attaque_2 = fun mstr -> match mstr.nom with
  | Golem ->  {nom=mstr.nom; pv = mstr.pv ; attaque = 4 ; loot= mstr.loot ; nombre = mstr.nombre; speed = mstr.speed}
  | Nuee_de_moustiques ->  {nom=mstr.nom; pv = mstr.pv ; attaque = 1/2*mstr.nombre ; loot= mstr.loot ; nombre = mstr.nombre; speed = mstr.speed}
  | Sanglier ->  {nom=mstr.nom; pv = mstr.pv; attaque = 2 ; loot= mstr.loot ; nombre = mstr.nombre; speed = mstr.speed}
  | Slime ->  {nom=mstr.nom; pv = mstr.pv; attaque = 7 ; loot= mstr.loot ; nombre = mstr.nombre;  speed = mstr.speed};;

let generer_le_monstre =  ( generer_attaque_2(generer_pv_loot_1 generer_monstre_0 ));;

let rencontre_malheureuse = fun perso ->
  (combattre perso generer_le_monstre );;


(* Appel et lanceur *)

let mon_monstre = {nom=Golem; pv = 25 ; attaque = 1 ; loot= Eponge ; nombre = 10; speed = 1};;

let personnage = {nom = "ani" ; classe = Guerrier ;  genre = Female  ; pv = 100000 ; exp = 0; niveau = 0; sac = []; speed = 1 } ;;

affichage_etat_perso personnage;;
